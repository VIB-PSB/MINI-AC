name: MINI-AC test suite

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  nf-test:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Nextflow
      uses: nf-core/setup-nextflow@v1.3.0

    - name: Setup singularity
      uses: eWaterCycle/setup-singularity@v7
      with:
        singularity-version: 3.8.3

    - name: Setup nf-test
      run: wget -qO- https://code.askimed.com/install/nf-test | bash

    - name: Fetch motif mapping files
      run: |
        curl -k -o tests/data/zma_v4/zma_v4_genome_wide_motif_mappings_chr1.bed https://floppy.psb.ugent.be/index.php/s/NekMYztyxEnsQiY/download/zma_v4_genome_wide_motif_mappings_chr1.bed
        curl -k -o tests/data/zma_v4/zma_v4_locus_based_motif_mappings_5kbup_1kbdown_chr1.bed https://floppy.psb.ugent.be/index.php/s/r2wQmFjPy79qSp7/download/zma_v4_locus_based_motif_mappings_5kbup_1kbdown_chr1.bed
        curl -k -o tests/data/ath/ath_genome_wide_motif_mappings.bed https://floppy.psb.ugent.be/index.php/s/iaZPwdrRGe3YDdK/download/ath_genome_wide_motif_mappings.bed
        curl -k -o tests/data/ath/ath_locus_based_motif_mappings_5kbup_1kbdown.bed https://floppy.psb.ugent.be/index.php/s/qcQ7KndzHaSpd9e/download/ath_locus_based_motif_mappings_5kbup_1kbdown.bed

    - name: Prepare nf-test config file
      run: cat .github/workflows/test.config | sed "s/%TMP%/${{ env.RUNNER_TEMP }}/g" > tests/nextflow.config

    - name: Run nf-test
      shell: bash
      run: ./nf-test test
